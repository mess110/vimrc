#!/usr/bin/env python
# -*- coding: utf-8 -*-

import json
import os
import sys
import urllib2


# https://openweathermap.org/weather-conditions
# https://emojipedia.org
icons = {
    'thunderstorm with light rain': '⛈️',
    'thunderstorm with heavy rain': '⛈️',
    'light thunderstorm': '🌩️',
    'thunderstorm': '🌩️',
    'heavy thunderstorm': '🌩️',
    'ragged thunderstorm': '🌩️',
    'thunderstorm with light drizzle': '⛈️',
    'thunderstorm with drizzle': '⛈️',
    'thunderstorm with heavy drizzle': '⛈️',

    'light intensity drizzle': '🌦️',
    'drizzle': '🌦️',
    'heavy intensity drizzle': '🌦️',
    'light intensity drizzle rain': '🌦️',
    'drizzle rain': '🌦️',
    'heavy intensity drizzle rain': '🌦️',
    'shower rain and drizzle': '🌦️',
    'heavy shower rain and drizzle': '🌦️',
    'shower drizzle': '🌦️',

    'light rain': '🌦️',
    'moderate rain': '🌧️',
    'heavy intensity rain': '🌧️',
    'very heavy rain': '🌧️',
    'extreme rain': '🌧️',
    'freezing rain': '🌧️',
    'light intensity shower rain': '🌧️',
    'shower rain': '🌧️',
    'heavy intensity shower rain': '🌧️',
    'ragged shower rain': '🌧️',
    'rain': '🌧️',

    'light snow': '❄️',
    'snow': '❄️',
    'heavy snow': '❄️',
    'sleet': '❄️',
    'shower sleet': '🌨️',
    'light rain and snow': '🌨️',
    'rain and snow': '🌨️',
    'light shower snow': '🌨️',
    'shower snow': '🌨️',
    'heavy shower snow': '🌨️',

    'mist': '🌫️',
    'smoke': '🌫️',
    'haze': '🌫️',
    'sand, dust whirls': '🌫️',
    'fog': '🌫️',
    'sand': '🌫️',
    'dust': '🌫️',
    'volcanic ash': '🌋',
    'squalls': '🌫️',
    'tornado': '🌪️',

    'clear sky': '☀️',
    'few clouds': '🌤️',
    'scattered clouds': '🌥️',
    'broken clouds': '☁️',
    'overcast clouds': '☁️'

}


def format_icon(x):
    description = str(x['description'])
    return icons.get(description, description)


def weather_conditions(query, app_id):
    url = "http://api.openweathermap.org/data/2.5/weather?q=" + query + "&units=metric&APPID=" + app_id
    headers = {
        'User-Agent' : 'ConkyWeatherBot/0.1'
    }
    req = urllib2.Request(url, None, headers)
    try:
        response = urllib2.urlopen(req)
        j = json.loads(response.read())
        if int(j['cod']) == 200:
            icon_string = ' '.join(map(format_icon, j['weather']))
            location_name = str(j['name'])
            location_temp = str(j['main']['temp']) + '°C'
            return "%s %s" % (icon_string, location_temp)
        else:
            return 'Error getting weather 🌋'
    except urllib2.HTTPError:
        return 'Invalid APP_ID 🌋'


if __name__ == '__main__':
    if 'CONKY_QUERY' not in os.environ:
        print 'CONKY_QUERY env variable missing'
        sys.exit(1)
    if 'CONKY_APP_ID' not in os.environ:
        print 'CONKY_APP_ID env variable missing'
        sys.exit(1)

    query = os.environ['CONKY_QUERY']
    app_id = os.environ['CONKY_APP_ID']

    output = weather_conditions(query, app_id)
    print(output)
