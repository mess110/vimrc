#!/usr/bin/env python
# -*- coding: utf-8 -*-

import json
import os
import sys
import urllib2


# https://openweathermap.org/weather-conditions
# https://emojipedia.org
icons = {
    'thunderstorm with light rain': 'â›ˆï¸',
    'thunderstorm with heavy rain': 'â›ˆï¸',
    'light thunderstorm': 'ğŸŒ©ï¸',
    'thunderstorm': 'ğŸŒ©ï¸',
    'heavy thunderstorm': 'ğŸŒ©ï¸',
    'ragged thunderstorm': 'ğŸŒ©ï¸',
    'thunderstorm with light drizzle': 'â›ˆï¸',
    'thunderstorm with drizzle': 'â›ˆï¸',
    'thunderstorm with heavy drizzle': 'â›ˆï¸',

    'light intensity drizzle': 'ğŸŒ¦ï¸',
    'drizzle': 'ğŸŒ¦ï¸',
    'heavy intensity drizzle': 'ğŸŒ¦ï¸',
    'light intensity drizzle rain': 'ğŸŒ¦ï¸',
    'drizzle rain': 'ğŸŒ¦ï¸',
    'heavy intensity drizzle rain': 'ğŸŒ¦ï¸',
    'shower rain and drizzle': 'ğŸŒ¦ï¸',
    'heavy shower rain and drizzle': 'ğŸŒ¦ï¸',
    'shower drizzle': 'ğŸŒ¦ï¸',

    'light rain': 'ğŸŒ¦ï¸',
    'moderate rain': 'ğŸŒ§ï¸',
    'heavy intensity rain': 'ğŸŒ§ï¸',
    'very heavy rain': 'ğŸŒ§ï¸',
    'extreme rain': 'ğŸŒ§ï¸',
    'freezing rain': 'ğŸŒ§ï¸',
    'light intensity shower rain': 'ğŸŒ§ï¸',
    'shower rain': 'ğŸŒ§ï¸',
    'heavy intensity shower rain': 'ğŸŒ§ï¸',
    'ragged shower rain': 'ğŸŒ§ï¸',
    'rain': 'ğŸŒ§ï¸',

    'light snow': 'â„ï¸',
    'snow': 'â„ï¸',
    'heavy snow': 'â„ï¸',
    'sleet': 'â„ï¸',
    'shower sleet': 'ğŸŒ¨ï¸',
    'light rain and snow': 'ğŸŒ¨ï¸',
    'rain and snow': 'ğŸŒ¨ï¸',
    'light shower snow': 'ğŸŒ¨ï¸',
    'shower snow': 'ğŸŒ¨ï¸',
    'heavy shower snow': 'ğŸŒ¨ï¸',

    'mist': 'ğŸŒ«ï¸',
    'smoke': 'ğŸŒ«ï¸',
    'haze': 'ğŸŒ«ï¸',
    'sand, dust whirls': 'ğŸŒ«ï¸',
    'fog': 'ğŸŒ«ï¸',
    'sand': 'ğŸŒ«ï¸',
    'dust': 'ğŸŒ«ï¸',
    'volcanic ash': 'ğŸŒ‹',
    'squalls': 'ğŸŒ«ï¸',
    'tornado': 'ğŸŒªï¸',

    'clear sky': 'â˜€ï¸',
    'few clouds': 'ğŸŒ¤ï¸',
    'scattered clouds': 'ğŸŒ¥ï¸',
    'broken clouds': 'â˜ï¸',
    'overcast clouds': 'â˜ï¸'
}


def format_icon(x):
    description = str(x['description'])
    # print(x['description'])
    return icons.get(description, description)


def weather_conditions(query, app_id):
    url = "http://api.openweathermap.org/data/2.5/weather?q=" + query + "&units=metric&APPID=" + app_id
    headers = {
        'User-Agent' : 'ConkyWeatherBot/0.1'
    }
    req = urllib2.Request(url, None, headers)
    # print(url)
    try:
        response = urllib2.urlopen(req)
        j = json.loads(response.read())
        if int(j['cod']) == 200:
            icon_string = ' '.join(map(format_icon, j['weather']))
            location_name = str(j['name'])
            location_temp = str(j['main']['temp']) + 'Â°C'
            return "%s %s" % (icon_string, location_temp)
        else:
            return 'Error getting weather ğŸŒ‹'
    except urllib2.HTTPError:
        return 'Invalid APP_ID ğŸŒ‹'


# https://gist.github.com/miklb/ed145757971096565723
# https://en.wikipedia.org/wiki/Lunar_phase#Lunar_phase_calculation
def lunar_phase():
    import math, decimal, datetime
    dec = decimal.Decimal

    def position(now=None):
        if now is None:
            now = datetime.datetime.now()

        diff = now - datetime.datetime(2001, 1, 1)
        days = dec(diff.days) + (dec(diff.seconds) / dec(86400))
        lunations = dec("0.20439731") + (days * dec("0.03386319269"))

        return lunations % dec(1)

    def phase(pos):
        index = (pos * dec(8)) + dec("0.5")
        index = math.floor(index)
        return {
            0: "ğŸŒ‘", # "New Moon"
            1: "ğŸŒ’", # "Waxing Crescent"
            2: "ğŸŒ“", # "First Quarter"
            3: "ğŸŒ”", # "Waxing Gibbous"
            4: "ğŸŒ•", # "Full Moon"
            5: "ğŸŒ–", # "Waning Gibbous"
            6: "ğŸŒ—", # "Last Quarter"
            7: "ğŸŒ˜", # "Waning Crescent
        }[int(index) & 7]

    pos = position()
    phasename = phase(pos)
    roundedpos = round(float(pos), 3)
    return phasename
    # return "%s (%s)" % (phasename, roundedpos)


if __name__ == '__main__':
    if 'CONKY_QUERY' not in os.environ:
        print 'CONKY_QUERY env variable missing ğŸŒ‹'
        sys.exit(1)
    if 'CONKY_APP_ID' not in os.environ:
        print 'CONKY_APP_ID env variable missing ğŸŒ‹'
        sys.exit(1)

    query = os.environ['CONKY_QUERY']
    app_id = os.environ['CONKY_APP_ID']

    output = weather_conditions(query, app_id)
    print(output + "" + lunar_phase())
