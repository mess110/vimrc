#!/usr/bin/env python
# -*- coding: utf-8 -*-

import platform
import urllib2
import json
import os
import sys
import argparse

from random import choice
from subprocess import call


class MyException(Exception):
    pass

parser = argparse.ArgumentParser(formatter_class=argparse.RawTextHelpFormatter, description=\
"""
The default subreddit is 'earthporn'.
You can specify a different one by typing it after the program name.

Example:

    change_background wallpappers

Install instructions:

curl https://raw.githubusercontent.com/mess110/vimrc/master/bin/change_background > change_background; chmod +x change_background;
""")
# args = parser.parse_args()

if len(sys.argv) > 1:
    subreddit = sys.argv[1]
else:
    subreddit = 'earthporn'


url = "http://www.reddit.com/r/{0}.json".format(subreddit)
headers = {
  'User-Agent' : 'PrettyBackgroundBot/0.1'
}
working_dir = os.path.dirname(os.path.abspath(__file__))
directory = os.path.join(working_dir, 'tmp')
operating_system = platform.system().lower()
desktop_session = os.environ.get('DESKTOP_SESSION').lower()


def subreddit_frontpage():
    req = urllib2.Request(url, None, headers)
    response = urllib2.urlopen(req)
    return json.loads(response.read())['data']['children']


def get_random_link():
    items = subreddit_frontpage()

    if not items:
        raise MyException("No items found in subreddit")

    link = choice(items)['data']
    url = str(link['url'])

    print("Found link %s with name %s" % (url, link['name']))

    if 'imgur' in url and not extension_exists(url):
        link['url'] += '.png'

    if 'gfycat.com' in url:
        base_part = url.split('/')[-1]
        link['url'] = 'https://thumbs.gfycat.com/' + base_part + '-poster.jpg'

    return link


def extension_exists(url):
    return url.endswith('.jpg') or url.endswith('.jpeg') or url.endswith('.png')


def download_url(link):
    file_path = os.path.join(directory, link['name'])
    wallpapper = urllib2.urlopen(link['url'])
    output = open(file_path, 'wb')
    output.write(wallpapper.read())
    output.close()
    return file_path


def set_linux_wallpapper(link):
    if desktop_session in ['gnome', 'gnome-shell', 'ubuntu']:
        file_path = download_url(link)
        call(["gsettings", "set", "org.gnome.desktop.background", "picture-uri", "file://" + file_path])
    elif desktop_session in ['i3']:
        file_path = download_url(link)
        output = call(['which', 'feh'])
        if output != 0:
            raise MyException("feh not installed")

        call(['feh', '--bg-fill', file_path])
    else:
        raise MyException("Unknown desktop manager: %s" % desktop_session)


def set_wallpapper():
    link = get_random_link()

    if operating_system == 'linux':
        set_linux_wallpapper(link)
    elif operating_system == 'windows':
        raise MyException("No windows support. Yet.")
    else:
        raise MyException("OS not supported. yet")


if not os.path.exists(directory):
      os.makedirs(directory)


if __name__ == "__main__":
    try:
        set_wallpapper()
    except MyException as e:
        print e.args[0]
